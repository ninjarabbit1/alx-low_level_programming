More work on functions and nested loops
